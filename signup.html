<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Dashverse</title>
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-container { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; max-width: 1000px; width: 100%; display: flex; min-height: 600px; }
        .left-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 60px 40px; color: white; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .logo { width: 150px; height: 150px; margin-bottom: 30px; animation: float 3s ease-in-out infinite; object-fit: contain; }
        .logo-fallback { width: 150px; height: 150px; margin-bottom: 30px; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 4rem; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .brand-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 15px; }
        .brand-subtitle { font-size: 1.1rem; opacity: 0.9; }
        .right-section { flex: 1; padding: 50px 50px; display: flex; flex-direction: column; justify-content: flex-start; overflow-y: auto; max-height: 90vh; }
        .form-header { margin-bottom: 25px; }
        .form-header h2 { font-size: 2rem; color: #2c3e50; margin-bottom: 12px; }
        .form-header p { color: #6c757d; font-size: 1rem; line-height: 1.5; }
        .user-type-selector { display: flex; gap: 15px; margin-bottom: 25px; }
        .user-type-card { flex: 1; padding: 20px; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center; background: white; }
        .user-type-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .user-type-card.active { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); }
        .user-type-card .icon { font-size: 2rem; margin-bottom: 10px; }
        .user-type-card .title { font-size: 1.1rem; font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
        .user-type-card .description { font-size: 0.875rem; color: #6c757d; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #495057; font-weight: 500; font-size: 0.95rem; }
        .required { color: #dc3545; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.1); }
        .form-input.error { border-color: #dc3545; }
        .form-input.success { border-color: #28a745; }
        .password-input-wrapper { position: relative; }
        .password-input-wrapper .form-input { padding-right: 45px; }
        .password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px; color: #6c757d; }
        .password-toggle svg { width: 20px; height: 20px; display: block; }
        .error-message { color: #dc3545; font-size: 0.875rem; margin-top: 5px; display: none; }
        .error-message.show { display: block; }
        .success-message { color: #28a745; font-size: 0.875rem; margin-top: 5px; display: none; }
        .success-message.show { display: block; }
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 10px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .form-links { margin-top: 20px; text-align: center; }
        .form-links a { color: #667eea; text-decoration: none; font-weight: 500; }
        .form-links a:hover { color: #764ba2; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .writer-fields { display: none; }
        .writer-fields.show { display: block; }
        .loading-msg { text-align: center; padding: 10px; color: #667eea; font-size: 0.875rem; display: none; }
        .loading-msg.show { display: block; }
        .already-exists-banner { background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 16px 18px; margin-bottom: 20px; display: none; text-align: center; }
        .already-exists-banner.show { display: block; }
        .already-exists-banner p { color: #856404; font-size: 0.95rem; margin-bottom: 10px; }
        .already-exists-banner .banner-links { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .already-exists-banner a.btn-signin { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 9px 22px; border-radius: 7px; text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: opacity 0.2s; }
        .already-exists-banner a.btn-signin:hover { opacity: 0.88; }
        .already-exists-banner a.btn-forgot { display: inline-block; background: white; color: #667eea; padding: 9px 22px; border-radius: 7px; text-decoration: none; font-weight: 600; font-size: 0.9rem; border: 2px solid #667eea; transition: background 0.2s, color 0.2s; }
        .already-exists-banner a.btn-forgot:hover { background: #667eea; color: white; }
        @media (max-width: 768px) { .auth-container { flex-direction: column; } .left-section { padding: 40px 30px; } .logo { width: 100px; height: 100px; } .brand-title { font-size: 2rem; } .right-section { padding: 40px 30px; } .user-type-selector { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="left-section">
            <img src="dashtoon_logo.jpg" alt="Dashverse Logo" class="logo"
                 onerror="this.style.display='none';document.getElementById('logoFallback').style.display='flex';">
            <div class="logo-fallback" id="logoFallback" style="display:none;">üé¨</div>
            <h1 class="brand-title">Dashverse</h1>
            <p class="brand-subtitle">Join our creative community</p>
        </div>

        <div class="right-section">
            <div class="form-header">
                <h2>Create Account</h2>
                <p>Choose your account type and get started</p>
            </div>

            <div class="user-type-selector">
                <div class="user-type-card active" data-type="dashverse" id="dashverseCard">
                    <div class="icon">üè¢</div>
                    <div class="title">Dashverse User</div>
                    <div class="description">Internal team member</div>
                </div>
                <div class="user-type-card" data-type="writer" id="writerCard">
                    <div class="icon">‚úçÔ∏è</div>
                    <div class="title">Writer</div>
                    <div class="description">Content creator</div>
                </div>
            </div>

            <div class="loading-msg" id="loadingMsg">‚è≥ Connecting to server...</div>
            <div class="alert alert-error" id="errorAlert"></div>

            <div class="already-exists-banner" id="alreadyExistsBanner">
                <p>‚ö†Ô∏è An account with this email already exists.<br>Please sign in or reset your password.</p>
                <div class="banner-links">
                    <a href="login.html" class="btn-signin">üîê Sign In</a>
                    <a href="forgot-password.html" class="btn-forgot">üîë Forgot Password?</a>
                </div>
            </div>

            <form id="signupForm" autocomplete="off">
                <div class="form-group">
                    <label class="form-label">Full Name <span class="required">*</span></label>
                    <input type="text" class="form-input" id="name" placeholder="Your Name" required maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address <span class="required">*</span></label>
                    <input type="email" class="form-input" id="email" placeholder="your@email.com" required maxlength="254">
                    <div class="error-message" id="emailDomainError">‚ö†Ô∏è Only @dashverse.ai emails are allowed for Dashverse users.</div>
                    <div class="success-message" id="emailDomainSuccess">‚úÖ Valid Dashverse email!</div>
                </div>

                <div class="writer-fields" id="writerFields">
                    <div class="form-group">
                        <label class="form-label">Phone Number <span class="required">*</span></label>
                        <input type="tel" class="form-input" id="phone" placeholder="" maxlength="20">
                        <div class="error-message" id="phoneError">Phone number is required</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company <span class="required">*</span></label>
                        <input type="text" class="form-input" id="company" placeholder="Your Company" maxlength="200">
                        <div class="error-message" id="companyError">Company name is required</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Password <span class="required">*</span></label>
                    <div class="password-input-wrapper">
                        <input type="password" class="form-input" id="password" placeholder="At least 6 characters" required maxlength="128">
                        <button type="button" class="password-toggle" id="togglePassword">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Confirm Password <span class="required">*</span></label>
                    <div class="password-input-wrapper">
                        <input type="password" class="form-input" id="confirmPassword" placeholder="Re-enter password" required maxlength="128">
                        <button type="button" class="password-toggle" id="toggleConfirmPassword">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="signupBtn">Create Account</button>
            </form>

            <div class="form-links">
                Already have an account? <a href="login.html">Sign In</a>
            </div>
        </div>
    </div>

    <script type="module">
    import {
        auth, db, ensureInitialized, createUserWithEmailAndPassword, sendEmailVerification,
        doc, setDoc, serverTimestamp,
        isValidEmail, truncate, RateLimiter, SecureSession
    } from './firebase.js';

    let selectedUserType = 'dashverse';
    let firebaseReady    = false;
    const signupLimiter  = new RateLimiter(3, 15 * 60 * 1000);

    const eyeOpen   = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>`;
    const eyeClosed = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>`;

    function showError(msg) {
        document.getElementById('alreadyExistsBanner').classList.remove('show');
        const alert = document.getElementById('errorAlert');
        alert.textContent = msg;
        alert.classList.add('show');
        setTimeout(() => alert.classList.remove('show'), 6000);
    }

    function showAlreadyExists() {
        document.getElementById('errorAlert').classList.remove('show');
        document.getElementById('alreadyExistsBanner').classList.add('show');
        document.getElementById('email').classList.add('error');
    }

    function hideAllAlerts() {
        document.getElementById('errorAlert').classList.remove('show');
        document.getElementById('alreadyExistsBanner').classList.remove('show');
    }

    function clearEmailFeedback() {
        const emailInput = document.getElementById('email');
        document.getElementById('emailDomainError').classList.remove('show');
        document.getElementById('emailDomainSuccess').classList.remove('show');
        emailInput.classList.remove('error', 'success');
    }

    function validateEmailDomain() {
        const emailInput = document.getElementById('email');
        const email      = emailInput.value.trim().toLowerCase();
        const errorMsg   = document.getElementById('emailDomainError');
        const successMsg = document.getElementById('emailDomainSuccess');
        document.getElementById('alreadyExistsBanner').classList.remove('show');
        if (selectedUserType !== 'dashverse') { clearEmailFeedback(); return; }
        if (!email || email.length < 3) { clearEmailFeedback(); return; }
        if (email.includes('@')) {
            const domain = email.split('@')[1] || '';
            if (domain === '' || 'dashverse.ai'.startsWith(domain)) {
                clearEmailFeedback();
            } else if (email.endsWith('@dashverse.ai')) {
                errorMsg.classList.remove('show');
                successMsg.classList.add('show');
                emailInput.classList.remove('error');
                emailInput.classList.add('success');
            } else {
                successMsg.classList.remove('show');
                errorMsg.classList.add('show');
                emailInput.classList.remove('success');
                emailInput.classList.add('error');
            }
        } else { clearEmailFeedback(); }
    }

    async function waitForFirebase() {
        const loadingMsg = document.getElementById('loadingMsg');
        const signupBtn  = document.getElementById('signupBtn');
        loadingMsg.classList.add('show');
        signupBtn.disabled = true;
        try {
            await ensureInitialized();
            firebaseReady     = true;
            loadingMsg.classList.remove('show');
            signupBtn.disabled = false;
        } catch (e) {
            loadingMsg.textContent = '‚ùå Failed to connect. Please refresh.';
            console.error('Firebase init failed:', e);
        }
    }

    waitForFirebase();

    document.getElementById('dashverseCard').addEventListener('click', function () {
        selectedUserType = 'dashverse';
        this.classList.add('active');
        document.getElementById('writerCard').classList.remove('active');
        document.getElementById('writerFields').classList.remove('show');
        validateEmailDomain();
    });

    document.getElementById('writerCard').addEventListener('click', function () {
        selectedUserType = 'writer';
        this.classList.add('active');
        document.getElementById('dashverseCard').classList.remove('active');
        document.getElementById('writerFields').classList.add('show');
        clearEmailFeedback();
    });

    document.getElementById('email').addEventListener('input', validateEmailDomain);
    document.getElementById('name').addEventListener('input', hideAllAlerts);

    function setupToggle(btnId, inputId) {
        document.getElementById(btnId).addEventListener('click', function () {
            const input  = document.getElementById(inputId);
            const isPass = input.type === 'password';
            input.type   = isPass ? 'text' : 'password';
            this.innerHTML = isPass ? eyeClosed : eyeOpen;
        });
    }
    setupToggle('togglePassword', 'password');
    setupToggle('toggleConfirmPassword', 'confirmPassword');

    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideAllAlerts();
        if (!firebaseReady) { showError('Still connecting. Please wait...'); return; }
        if (!signupLimiter.canProceed()) { showError('Too many attempts. Please wait.'); return; }

        const name            = truncate(document.getElementById('name').value.trim(), 100);
        const email           = document.getElementById('email').value.trim().toLowerCase();
        const phone           = document.getElementById('phone').value.trim();
        const company         = truncate(document.getElementById('company').value.trim(), 200);
        const password        = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const signupBtn       = document.getElementById('signupBtn');

        if (!name || name.length < 2) { showError('Please enter a valid name.'); return; }
        if (!isValidEmail(email))     { showError('Invalid email format.'); return; }
        if (selectedUserType === 'dashverse' && !email.endsWith('@dashverse.ai')) { showError('Dashverse users must use @dashverse.ai email'); return; }
        if (selectedUserType === 'writer' && email.endsWith('@dashverse.ai')) { showError('Writers cannot use @dashverse.ai email'); return; }
        if (selectedUserType === 'writer') {
            if (!phone || phone.length < 7)     { showError('Valid phone number required'); return; }
            if (!company || company.length < 2) { showError('Company name required'); return; }
        }
        if (password.length < 6)         { showError('Password must be at least 6 characters'); return; }
        if (password !== confirmPassword) { showError('Passwords do not match'); return; }

        signupBtn.disabled    = true;
        signupBtn.textContent = 'Creating account...';

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user           = userCredential.user;
            const collectionName = selectedUserType === 'dashverse' ? 'admins' : 'writers';
            const userData = {
                uid: user.uid, name, email,
                role:          selectedUserType === 'dashverse' ? 'admin' : 'writer',
                emailVerified: false,
                createdAt:     serverTimestamp()
            };
            if (selectedUserType === 'writer') {
                userData.phone   = truncate(phone, 20);
                userData.company = company;
            }
            await setDoc(doc(db, collectionName, user.uid), userData);
            await sendEmailVerification(user);
            SecureSession.setPendingVerification({ email, name });
            window.location.href = 'verify-email.html';
        } catch (error) {
            console.error('Signup error:', error.code, error.message);
            if (error.code === 'auth/email-already-in-use') {
                showAlreadyExists();
            } else {
                let message = 'An error occurred. Please try again.';
                if (error.code === 'auth/invalid-email')               message = 'Invalid email format.';
                else if (error.code === 'auth/weak-password')          message = 'Password is too weak.';
                else if (error.code === 'auth/network-request-failed') message = 'Network error. Please check your connection.';
                showError(message);
            }
            signupBtn.disabled    = false;
            signupBtn.textContent = 'Create Account';
        }
    });
    </script>
</body>
</html>