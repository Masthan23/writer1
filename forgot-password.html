<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Dashverse</title>
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-container { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; max-width: 900px; width: 100%; display: flex; min-height: 550px; }
        .left-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 60px 40px; color: white; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .logo { width: 150px; height: 150px; margin-bottom: 30px; animation: float 3s ease-in-out infinite; object-fit: contain; }
        .logo-fallback { width: 150px; height: 150px; margin-bottom: 30px; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 4rem; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .brand-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 15px; }
        .brand-subtitle { font-size: 1.1rem; opacity: 0.9; }
        .right-section { flex: 1; padding: 60px 50px; display: flex; flex-direction: column; justify-content: center; }
        .form-header { margin-bottom: 40px; }
        .form-header h2 { font-size: 2rem; color: #2c3e50; margin-bottom: 10px; }
        .form-header p { color: #6c757d; font-size: 1rem; line-height: 1.6; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 8px; color: #495057; font-weight: 500; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.1); }
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .form-links { margin-top: 20px; text-align: center; }
        .form-links a { color: #667eea; text-decoration: none; font-weight: 500; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading-msg { text-align: center; padding: 10px; color: #667eea; font-size: 0.875rem; display: none; }
        .loading-msg.show { display: block; }
        @media (max-width: 768px) { .auth-container { flex-direction: column; } .left-section { padding: 40px 30px; } .logo { width: 100px; height: 100px; } .right-section { padding: 40px 30px; } }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="left-section">
            <img src="dashtoon_logo.jpg" alt="Dashverse Logo" class="logo"
                 onerror="this.style.display='none';document.getElementById('logoFallback').style.display='flex';">
            <div class="logo-fallback" id="logoFallback" style="display:none;">üé¨</div>
            <h1 class="brand-title">Dashverse</h1>
            <p class="brand-subtitle">Reset your password securely</p>
        </div>
        <div class="right-section">
            <div class="form-header">
                <h2>Reset Password</h2>
                <p>Enter your email address and we'll send you instructions to reset your password</p>
            </div>
            <div class="loading-msg" id="loadingMsg">‚è≥ Connecting to server...</div>
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>
            <form id="resetForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" class="form-input" id="email" placeholder="your@email.com" required maxlength="254">
                </div>
                <button type="submit" class="btn-primary" id="resetBtn">Send Reset Link</button>
            </form>
            <div class="form-links"><a href="login.html">Back to Sign In</a></div>
        </div>
    </div>

    <script type="module">
    import { auth, ensureInitialized, sendPasswordResetEmail, RateLimiter, isValidEmail } from './firebase.js';

    const resetLimiter = new RateLimiter(2, 5 * 60 * 1000);
    let firebaseReady  = false;

    function showAlert(type, message) {
        const s = document.getElementById('successAlert');
        const e = document.getElementById('errorAlert');
        s.classList.remove('show');
        e.classList.remove('show');
        if (type === 'success') { s.textContent = message; s.classList.add('show'); }
        else { e.textContent = message; e.classList.add('show'); }
        setTimeout(() => { s.classList.remove('show'); e.classList.remove('show'); }, 5000);
    }

    async function waitForFirebase() {
        const loadingMsg = document.getElementById('loadingMsg');
        const resetBtn   = document.getElementById('resetBtn');
        loadingMsg.classList.add('show');
        resetBtn.disabled = true;
        try {
            await ensureInitialized();
            firebaseReady     = true;
            loadingMsg.classList.remove('show');
            resetBtn.disabled = false;
        } catch (e) {
            loadingMsg.textContent = '‚ùå Failed to connect. Please refresh.';
        }
    }

    waitForFirebase();

    document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!firebaseReady) { showAlert('error', 'Still connecting. Please wait...'); return; }
        if (!resetLimiter.canProceed()) { showAlert('error', 'Too many requests. Please wait.'); return; }

        const email  = document.getElementById('email').value.trim().toLowerCase();
        const btn    = document.getElementById('resetBtn');

        if (!email || !isValidEmail(email)) { showAlert('error', 'Please enter a valid email address'); return; }

        btn.disabled    = true;
        btn.textContent = 'Sending...';

        try {
            await sendPasswordResetEmail(auth, email);
            showAlert('success', 'If an account exists with this email, a reset link has been sent.');
            document.getElementById('email').value = '';
            setTimeout(() => window.location.href = 'login.html', 4000);
        } catch (error) {
            if (error.code === 'auth/too-many-requests') {
                showAlert('error', 'Too many requests. Try again later.');
            } else {
                showAlert('success', 'If an account exists with this email, a reset link has been sent.');
            }
        }

        btn.disabled    = false;
        btn.textContent = 'Send Reset Link';
    });
    </script>
</body>
</html>