<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writer Dashboard - Dashverse</title>
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #2c3e50; }
        .navbar { background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); padding: 1rem 2.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(102,126,234,0.1); box-shadow: 0 2px 20px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 100; }
        .navbar-brand { display: flex; align-items: center; gap: 1rem; }
        .navbar-brand img { width: 42px; height: 42px; border-radius: 8px; }
        .navbar-title { font-size: 1.375rem; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .navbar-actions { display: flex; align-items: center; gap: 1.5rem; }
        .user-badge { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1.25rem; background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); border-radius: 50px; border: 1px solid rgba(102,126,234,0.2); }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem; }
        .user-name { font-weight: 500; color: #495057; }
        .writer-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .btn-logout { padding: 0.625rem 1.5rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .btn-logout:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245,87,108,0.4); }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 2rem 2.5rem; }
        .page-header { background: rgba(255,255,255,0.95); padding: 2.5rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .page-header h1 { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
        .page-header p { color: #6c757d; font-size: 1.0625rem; }
        .notification { padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: none; border: 1px solid; }
        .notification.show { display: flex; align-items: center; gap: 0.75rem; }
        .notification-success { background: rgba(40,167,69,0.1); border-color: rgba(40,167,69,0.3); color: #155724; }
        .notification-error { background: rgba(220,53,69,0.1); border-color: rgba(220,53,69,0.3); color: #721c24; }
        .notification-info { background: rgba(102,126,234,0.1); border-color: rgba(102,126,234,0.3); color: #004085; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: rgba(255,255,255,0.95); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); }
        .stat-label { color: #6c757d; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card { background: rgba(255,255,255,0.95); border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden; }
        .card-header { padding: 1.75rem 2rem; background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%); border-bottom: 1px solid rgba(102,126,234,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .card-title { font-size: 1.375rem; font-weight: 600; color: #2c3e50; }
        .card-body { padding: 2rem; }
        .show-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .show-card { background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%); border: 2px solid rgba(102,126,234,0.2); border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; }
        .show-card:hover { border-color: #667eea; transform: translateY(-4px); box-shadow: 0 8px 20px rgba(102,126,234,0.15); }
        .show-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); }
        .show-card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
        .show-id-badge { font-family: 'Courier New', monospace; font-weight: 600; color: #667eea; background: rgba(102,126,234,0.15); padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.8125rem; }
        .show-name { font-size: 1.125rem; font-weight: 600; color: #2c3e50; margin-bottom: 0.5rem; }
        .show-details { display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem; color: #6c757d; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; }
        .detail-label { font-weight: 500; }
        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .status-assets-shared { background: rgba(13,202,240,0.15); color: #055160; }
        .status-localization-notes-received { background: rgba(111,66,193,0.15); color: #3d1a7a; }
        .status-localization-discussion-wip { background: rgba(255,193,7,0.15); color: #856404; }
        .status-localization-completed { background: rgba(40,167,69,0.15); color: #155724; }
        .status-scripting-wip { background: rgba(255,152,0,0.15); color: #7a4100; }
        .status-draft1-partial { background: rgba(102,126,234,0.15); color: #3d4eac; }
        .status-draft1-all { background: rgba(23,162,184,0.15); color: #0c5460; }
        .status-completed { background: rgba(40,167,69,0.2); color: #155724; }
        .status-paused { background: rgba(220,53,69,0.15); color: #721c24; }
        .status-default { background: rgba(108,117,125,0.15); color: #495057; }
        .license-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .license-available { background: rgba(40,167,69,0.15); color: #155724; }
        .license-not-available { background: rgba(220,53,69,0.15); color: #721c24; }
        .locked-section { background: linear-gradient(135deg, rgba(102,126,234,0.03) 0%, rgba(118,75,162,0.03) 100%); border: 1px solid rgba(102,126,234,0.1); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
        .locked-section-title { font-size: 1rem; font-weight: 600; color: #495057; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .field-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
        .field-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid rgba(102,126,234,0.1); }
        .field-label { font-weight: 500; color: #495057; font-size: 0.875rem; }
        .field-value { color: #2c3e50; font-size: 0.875rem; text-align: right; max-width: 60%; word-break: break-word; }
        .locked-field-label { display: block; margin-bottom: 0.5rem; color: #495057; font-weight: 500; font-size: 0.9375rem; }
        .locked-field-label .lock-icon { font-size: 0.75rem; opacity: 0.6; margin-left: 0.25rem; }
        .locked-field-display { display: flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1rem; background: #f8f9fa; border: 2px solid rgba(108,117,125,0.15); border-radius: 8px; min-height: 50px; }
        .locked-field-display:hover { border-color: rgba(108,117,125,0.25); }
        .locked-field-text { flex: 1; font-size: 0.9rem; color: #2c3e50; word-break: break-all; }
        .locked-field-text.empty { color: #adb5bd; font-style: italic; font-size: 0.875rem; }
        .locked-field-text.is-link { color: #667eea; }
        .locked-field-actions { display: flex; gap: 0.375rem; flex-shrink: 0; }
        .btn-locked-action { padding: 0.375rem 0.625rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.25rem; }
        .btn-locked-copy { background: rgba(102,126,234,0.1); color: #667eea; }
        .btn-locked-copy:hover { background: rgba(102,126,234,0.2); }
        .btn-locked-copy.copied { background: rgba(40,167,69,0.15); color: #155724; }
        .btn-locked-open { background: rgba(40,167,69,0.1); color: #28a745; }
        .btn-locked-open:hover { background: rgba(40,167,69,0.2); }
        .btn-locked-action:disabled { opacity: 0.35; cursor: not-allowed; }
        .admin-locked-section { background: linear-gradient(135deg, rgba(255,193,7,0.04) 0%, rgba(255,152,0,0.04) 100%); border: 1px solid rgba(255,193,7,0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
        .admin-locked-title { font-size: 0.9375rem; font-weight: 600; color: #856404; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .admin-locked-title .hint { font-size: 0.75rem; color: #6c757d; font-weight: 400; }
        .admin-field-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
        .admin-field-item { background: white; border: 1px solid rgba(255,193,7,0.15); border-radius: 10px; padding: 1rem 1.25rem; }
        .admin-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.625rem; }
        .admin-field-label { font-size: 0.8125rem; font-weight: 600; color: #495057; display: flex; align-items: center; gap: 0.375rem; }
        .admin-field-value { display: flex; align-items: center; gap: 0.5rem; min-height: 32px; }
        .payment-status-badge { display: inline-block; padding: 0.3rem 0.875rem; border-radius: 12px; font-size: 0.8125rem; font-weight: 600; }
        .payment-status-pending { background: rgba(220,53,69,0.12); color: #721c24; }
        .payment-status-completed { background: rgba(40,167,69,0.12); color: #155724; }
        .payment-status-empty { background: rgba(108,117,125,0.08); color: #6c757d; }
        .editable-fields { margin-top: 0; }
        .form-section-title { font-size: 1.125rem; font-weight: 600; color: #2c3e50; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid rgba(102,126,234,0.1); display: flex; align-items: center; gap: 0.5rem; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .form-field { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; color: #495057; font-weight: 500; font-size: 0.9375rem; }
        .form-label .optional { color: #6c757d; font-weight: normal; font-size: 0.8125rem; }
        .form-input { width: 100%; padding: 0.875rem 1rem; border: 2px solid rgba(102,126,234,0.2); border-radius: 8px; font-size: 0.9375rem; font-family: inherit; transition: all 0.3s; background: white; }
        .form-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.1); }
        .form-divider { margin: 2.5rem 0 2rem; border: none; border-top: 2px dashed rgba(102,126,234,0.15); }
        .form-actions { margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1.5rem; border-top: 1px solid rgba(102,126,234,0.1); }
        .btn { padding: 0.875rem 2.5rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(108,117,125,0.1); color: #495057; border: 2px solid rgba(108,117,125,0.2); }
        .empty-state { text-align: center; padding: 4rem 2rem; color: #6c757d; }
        .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state h3 { font-size: 1.25rem; color: #495057; margin-bottom: 0.5rem; }
        .loading-overlay { text-align: center; padding: 3rem; color: #667eea; }
        .spinner { border: 3px solid rgba(102,126,234,0.2); border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .remarks-wrapper { border-radius: 16px; overflow: hidden; border: 1px solid rgba(102,126,234,0.15); box-shadow: 0 4px 20px rgba(0,0,0,0.06); background: #fff; }
        .remarks-topbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0.875rem 1.25rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .remarks-topbar-left { display: flex; align-items: center; gap: 0.75rem; }
        .remarks-topbar-icon { width: 34px; height: 34px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .remarks-topbar-title { font-size: 0.9375rem; font-weight: 700; color: white; letter-spacing: 0.2px; }
        .remarks-topbar-sub { font-size: 0.6875rem; color: rgba(255,255,255,0.65); margin-top: 0.1rem; }
        .remarks-topbar-right { display: flex; align-items: center; gap: 0.5rem; }
        .remarks-count-pill { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 0.6875rem; font-weight: 700; padding: 0.2rem 0.625rem; border-radius: 20px; display: flex; align-items: center; gap: 0.3rem; }
        .remarks-live-dot { width: 6px; height: 6px; border-radius: 50%; background: #7effa0; animation: blink-live 1.8s ease-in-out infinite; }
        @keyframes blink-live { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        .remarks-messages { background: #f5f6fa; padding: 1.25rem 1rem 0.75rem; min-height: 180px; max-height: 440px; overflow-y: auto; }
        .remarks-messages::-webkit-scrollbar { width: 4px; }
        .remarks-messages::-webkit-scrollbar-track { background: transparent; }
        .remarks-messages::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.25); border-radius: 4px; }
        .remarks-messages::-webkit-scrollbar-thumb:hover { background: rgba(102,126,234,0.45); }
        .remarks-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; gap: 0.5rem; }
        .remarks-empty-icon { font-size: 2.5rem; opacity: 0.25; margin-bottom: 0.25rem; }
        .remarks-empty-text { font-size: 0.9rem; color: #adb5bd; font-weight: 500; }
        .remarks-empty-sub { font-size: 0.75rem; color: #ced4da; }
        .remarks-date-sep { display: flex; align-items: center; gap: 0.625rem; margin: 0.75rem 0 0.5rem; }
        .remarks-date-sep::before, .remarks-date-sep::after { content: ''; flex: 1; height: 1px; background: #e2e5ee; }
        .remarks-date-label { font-size: 0.625rem; font-weight: 700; color: #adb5bd; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; }
        .remarks-inner { display: flex; flex-direction: column; gap: 0.5rem; }
        .msg-row { display: flex; align-items: flex-end; gap: 0.5rem; }
        .msg-row.from-admin  { flex-direction: row; justify-content: flex-start; }
        .msg-row.from-writer { flex-direction: row-reverse; justify-content: flex-start; }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; font-size: 0.6875rem; font-weight: 800; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; align-self: flex-end; margin-bottom: 2px; }
        .msg-row.from-admin  .msg-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .msg-row.from-writer .msg-avatar { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .msg-group { display: flex; flex-direction: column; max-width: 68%; gap: 0.2rem; }
        .msg-row.from-admin  .msg-group { align-items: flex-start; }
        .msg-row.from-writer .msg-group { align-items: flex-end; }
        .msg-sender-name { font-size: 0.6875rem; font-weight: 700; color: #868e96; padding: 0 0.375rem; margin-bottom: 0.1rem; }
        .msg-bubble { padding: 0.5rem 0.875rem; border-radius: 18px; font-size: 0.875rem; line-height: 1.5; word-wrap: break-word; white-space: pre-wrap; position: relative; }
        .msg-row.from-admin .msg-bubble { background: #ffffff; color: #2c3e50; border: 1px solid #e9ecef; border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
        .msg-row.from-writer .msg-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; border-bottom-right-radius: 4px; box-shadow: 0 2px 8px rgba(102,126,234,0.3); }
        .msg-time { font-size: 0.5625rem; color: #ced4da; padding: 0 0.375rem; margin-top: 0.1rem; }
        .msg-row.from-writer .msg-time { color: rgba(102,126,234,0.5); }
        .remarks-input-zone { background: #ffffff; border-top: 1px solid #e9ecef; padding: 0.875rem 1rem; display: flex; align-items: flex-end; gap: 0.625rem; }
        .remarks-input-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-size: 0.75rem; font-weight: 800; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .remarks-textarea { flex: 1; background: #f5f6fa; border: 1.5px solid #e2e5ee; border-radius: 22px; padding: 0.625rem 1rem; font-size: 0.875rem; font-family: inherit; resize: none; min-height: 40px; max-height: 120px; line-height: 1.45; color: #2c3e50; transition: border-color 0.2s, background 0.2s; }
        .remarks-textarea::placeholder { color: #adb5bd; }
        .remarks-textarea:focus { outline: none; border-color: #667eea; background: #fff; }
        .remarks-send-btn { width: 38px; height: 38px; border-radius: 50%; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 0.9375rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; box-shadow: 0 3px 10px rgba(102,126,234,0.35); }
        .remarks-send-btn:hover:not(:disabled) { transform: scale(1.08); box-shadow: 0 5px 16px rgba(102,126,234,0.5); }
        .remarks-send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .remarks-hint-bar { background: #fafbff; border-top: 1px solid #f0f1f8; padding: 0.375rem 1rem; display: flex; justify-content: space-between; align-items: center; }
        .remarks-hint { font-size: 0.5625rem; color: #ced4da; }
        .remarks-char { font-size: 0.5625rem; color: #ced4da; font-family: 'Courier New', monospace; }
        .remarks-char.warn  { color: #f4a523; }
        .remarks-char.limit { color: #dc3545; }

        .confirm-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .confirm-modal.show { display: flex; align-items: center; justify-content: center; padding: 2rem 1rem; }
        .confirm-content { background: white; border-radius: 16px; width: 90%; max-width: 700px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .confirm-header { padding: 1.5rem 2rem; background: linear-gradient(135deg, rgba(40,167,69,0.08) 0%, rgba(32,201,151,0.08) 100%); border-bottom: 2px solid rgba(40,167,69,0.2); display: flex; align-items: center; gap: 1rem; }
        .confirm-header-icon { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .confirm-header-text h3 { font-size: 1.25rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.25rem; }
        .confirm-header-text p { font-size: 0.875rem; color: #6c757d; }
        .confirm-body { padding: 1.5rem 2rem; max-height: 50vh; overflow-y: auto; }
        .confirm-show-info { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%); border-radius: 10px; margin-bottom: 1.25rem; border: 1px solid rgba(102,126,234,0.15); }
        .confirm-show-code { font-family: 'Courier New', monospace; font-weight: 700; color: #667eea; background: rgba(102,126,234,0.15); padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.875rem; }
        .confirm-show-name { font-weight: 600; color: #2c3e50; font-size: 1rem; }
        .confirm-section-title { font-size: 0.8125rem; font-weight: 600; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(102,126,234,0.1); }
        .confirm-changes-list { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.25rem; }
        .confirm-change-row { display: grid; grid-template-columns: 160px 1fr; gap: 0.75rem; padding: 0.625rem 0.75rem; border-radius: 8px; font-size: 0.875rem; align-items: start; }
        .confirm-change-row:nth-child(odd) { background: rgba(102,126,234,0.03); }
        .confirm-change-row.changed { background: rgba(40,167,69,0.06); border-left: 3px solid #28a745; }
        .confirm-change-field { font-weight: 600; color: #495057; font-size: 0.8125rem; }
        .confirm-change-value { color: #2c3e50; word-break: break-word; }
        .confirm-change-value.is-link { color: #667eea; font-size: 0.8125rem; word-break: break-all; }
        .confirm-change-diff { display: flex; flex-direction: column; gap: 0.25rem; }
        .confirm-old-value { color: #dc3545; text-decoration: line-through; font-size: 0.8125rem; opacity: 0.7; }
        .confirm-new-value { color: #28a745; font-weight: 500; }
        .confirm-new-value.is-link { color: #667eea; font-size: 0.8125rem; word-break: break-all; }
        .confirm-no-changes { text-align: center; padding: 2rem 1rem; color: #6c757d; }
        .confirm-no-changes-icon { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.4; }
        .confirm-summary { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: rgba(40,167,69,0.08); border: 1px solid rgba(40,167,69,0.2); border-radius: 8px; margin-bottom: 1.25rem; font-size: 0.875rem; color: #155724; }
        .confirm-summary .summary-icon { font-size: 1.25rem; flex-shrink: 0; }
        .confirm-footer { padding: 1.25rem 2rem; border-top: 2px solid rgba(40,167,69,0.15); display: flex; justify-content: flex-end; gap: 1rem; }
        .btn-confirm-cancel { padding: 0.75rem 2rem; background: rgba(108,117,125,0.1); color: #495057; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .btn-confirm-cancel:hover { background: rgba(108,117,125,0.2); }
        .btn-confirm-save { padding: 0.75rem 2rem; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-confirm-save:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40,167,69,0.4); }
        .btn-confirm-save:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }

        @media (max-width: 768px) {
            .main-container { padding: 1.5rem 1rem; }
            .navbar { padding: 1rem 1.5rem; flex-wrap: wrap; }
            .form-actions { flex-direction: column-reverse; }
            .btn { width: 100%; }
            .user-badge { order: 3; width: 100%; justify-content: center; margin-top: 0.75rem; }
            .show-cards-grid { grid-template-columns: 1fr; }
            .field-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .admin-field-grid { grid-template-columns: 1fr; }
            .confirm-content { width: 95%; }
            .confirm-change-row { grid-template-columns: 1fr; }
            .msg-group { max-width: 82%; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <img src="dashtoon_logo.jpg" alt="Dashverse">
            <span class="navbar-title">Dashverse Writer Portal</span>
        </div>
        <div class="navbar-actions">
            <div class="user-badge">
                <div class="user-avatar" id="userAvatar">W</div>
                <span class="user-name" id="userName">Writer</span>
                <span class="writer-badge">WRITER</span>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1>Welcome back, <span id="welcomeName">Writer</span></h1>
            <p>Manage your assigned shows, submit drafts, and track progress</p>
        </div>

        <div class="notification notification-success" id="successNotification"><strong>‚úì</strong> <span id="successText"></span></div>
        <div class="notification notification-error" id="errorNotification"><strong>‚úó</strong> <span id="errorText"></span></div>
        <div class="notification notification-info" id="infoNotification"><strong>‚Ñπ</strong> <span id="infoText"></span></div>

        <div class="stats-grid" id="statsGrid" style="display:none;">
            <div class="stat-card"><div class="stat-label">Assigned Shows</div><div class="stat-value" id="assignedShowsCount">0</div></div>
            <div class="stat-card"><div class="stat-label">Scripting WIP</div><div class="stat-value" id="inProgressCount">0</div></div>
            <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value" id="completedCount">0</div></div>
            <div class="stat-card"><div class="stat-label">Total Approved Episodes</div><div class="stat-value" id="totalEpisodesCount">0</div></div>
        </div>

        <!-- Show Selection Card -->
        <div class="card" id="showSelectionCard">
            <div class="card-header">
                <h2 class="card-title">Your Assigned Shows</h2>
            </div>
            <div class="card-body">
                <div id="showsContainer">
                    <div class="loading-overlay"><div class="spinner"></div><p>Loading your shows...</p></div>
                </div>
            </div>
        </div>

        <!-- Show Editor Card -->
        <div class="card" id="showEditorCard" style="display:none;">
            <div class="card-header">
                <h2 class="card-title" id="editorShowTitle">Show Details</h2>
                <button class="btn btn-secondary" onclick="backToSelection()">‚Üê Back</button>
            </div>
            <div class="card-body">

                <!-- SECTION 1: Locked Show Info -->
                <div class="locked-section">
                    <div class="locked-section-title">üîí Show Information <span style="font-size:0.75rem;color:#6c757d;font-weight:400;">‚Äî Read only, managed by admin</span></div>
                    <div class="field-grid" id="lockedFieldsGrid"></div>
                </div>

                <!-- SECTION 2: Admin-Only Fields -->
                <div class="admin-locked-section">
                    <div class="admin-locked-title">
                        üîí Status, Episodes &amp; Payment
                        <span class="hint">‚Äî Managed by admin only</span>
                    </div>
                    <div class="admin-field-grid" id="adminLockedFieldsGrid"></div>
                </div>

                <!-- SECTION 3: Writer-Editable Fields -->
                <div class="editable-fields">
                    <form id="updateForm">

                        <div class="form-section-title">üìÅ Assets &amp; Localization</div>
                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label" for="showAssetsLink">Show Assets Link <span class="optional">(Optional)</span></label>
                                <input type="url" class="form-input" id="showAssetsLink" placeholder="https://drive.google.com/..." maxlength="2000">
                            </div>
                            <div class="form-field">
                                <label class="form-label" for="localizationNotesLink">Localization Notes Link <span class="optional">(Optional)</span></label>
                                <input type="url" class="form-input" id="localizationNotesLink" placeholder="https://drive.google.com/..." maxlength="2000">
                            </div>
                        </div>

                        <hr class="form-divider">

                        <div class="form-section-title">üìù Screenplay Drafts</div>
                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label" for="screenplayDraft1">Screenplay Draft 1 <span class="optional">(Optional)</span></label>
                                <input type="url" class="form-input" id="screenplayDraft1" placeholder="https://docs.google.com/..." maxlength="2000">
                            </div>
                            <div class="form-field">
                                <label class="locked-field-label">Screenplay Draft 1 with Comments <span class="lock-icon">üîí</span></label>
                                <div class="locked-field-display">
                                    <span class="locked-field-text empty" id="draft1CommentsText">Not provided yet</span>
                                    <div class="locked-field-actions">
                                        <button type="button" class="btn-locked-action btn-locked-copy" id="copy-draft1Comments" disabled onclick="copyLockedField('draft1Comments','copy-draft1Comments')">üìã Copy</button>
                                        <button type="button" class="btn-locked-action btn-locked-open" id="open-draft1Comments" disabled onclick="openLockedField('draft1Comments')">üîó Open</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label" for="screenplayDraft2">Screenplay Draft 2 <span class="optional">(Optional)</span></label>
                                <input type="url" class="form-input" id="screenplayDraft2" placeholder="https://docs.google.com/..." maxlength="2000">
                            </div>
                            <div class="form-field">
                                <label class="locked-field-label">Screenplay Draft 2 with Comments <span class="lock-icon">üîí</span></label>
                                <div class="locked-field-display">
                                    <span class="locked-field-text empty" id="draft2CommentsText">Not provided yet</span>
                                    <div class="locked-field-actions">
                                        <button type="button" class="btn-locked-action btn-locked-copy" id="copy-draft2Comments" disabled onclick="copyLockedField('draft2Comments','copy-draft2Comments')">üìã Copy</button>
                                        <button type="button" class="btn-locked-action btn-locked-open" id="open-draft2Comments" disabled onclick="openLockedField('draft2Comments')">üîó Open</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label" for="finalScreenplayLink">Final Screenplay Link <span class="optional">(Optional)</span></label>
                                <input type="url" class="form-input" id="finalScreenplayLink" placeholder="https://docs.google.com/..." maxlength="2000">
                            </div>
                        </div>

                        <hr class="form-divider">

                        <div class="form-section-title">üßæ Invoice Links</div>
                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label" for="advanceInvoiceLink">Advance Invoice Link <span class="optional">(Optional)</span></label>
                                <input type="url" class="form-input" id="advanceInvoiceLink" placeholder="https://drive.google.com/..." maxlength="2000">
                            </div>
                            <div class="form-field">
                                <label class="form-label" for="finalInvoiceLink">Final Invoice Link <span class="optional">(Optional)</span></label>
                                <input type="url" class="form-input" id="finalInvoiceLink" placeholder="https://drive.google.com/..." maxlength="2000">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                            <button type="submit" class="btn btn-primary" id="saveButton">Review &amp; Save Changes</button>
                        </div>
                    </form>

                    <hr class="form-divider">

                    <!-- ‚ïê‚ïê‚ïê REMARKS ‚ïê‚ïê‚ïê -->
                    <div class="form-section-title">üí¨ Remarks</div>

                    <div class="remarks-wrapper">
                        <div class="remarks-topbar">
                            <div class="remarks-topbar-left">
                                <div class="remarks-topbar-icon">üí¨</div>
                                <div>
                                    <div class="remarks-topbar-title">Remarks</div>
                                    <div class="remarks-topbar-sub">Conversation between you and the admin</div>
                                </div>
                            </div>
                            <div class="remarks-topbar-right">
                                <div class="remarks-count-pill">
                                    <div class="remarks-live-dot"></div>
                                    <span id="remarksMsgCount">0 messages</span>
                                </div>
                            </div>
                        </div>

                        <div class="remarks-messages" id="remarksMessagesArea"></div>

                        <div class="remarks-input-zone">
                            <div class="remarks-input-avatar" id="remarksInputAvatar">W</div>
                            <textarea
                                class="remarks-textarea"
                                id="writerChatInput"
                                placeholder="Write a remark‚Ä¶"
                                rows="1"
                                maxlength="1000"
                            ></textarea>
                            <button class="remarks-send-btn" id="writerChatSendBtn" onclick="sendWriterMessage()">‚û§</button>
                        </div>

                        <div class="remarks-hint-bar">
                            <span class="remarks-hint">Enter to send ¬∑ Shift+Enter for new line</span>
                            <span class="remarks-char" id="remarksCharCounter">0 / 1000</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-header">
                <div class="confirm-header-icon">üìù</div>
                <div class="confirm-header-text">
                    <h3>Review Your Changes</h3>
                    <p>Please verify everything looks correct before saving.</p>
                </div>
            </div>
            <div class="confirm-body" id="confirmBody"></div>
            <div class="confirm-footer">
                <button class="btn-confirm-cancel" onclick="closeConfirmModal()">‚Üê Go Back &amp; Edit</button>
                <button class="btn-confirm-save" id="confirmSaveBtn">‚úì Confirm &amp; Save</button>
            </div>
        </div>
    </div>

    <script type="module">
    import {
        auth, db, ensureInitialized,
        onAuthStateChanged, doc, updateDoc, getDocs,
        collection, query, where, onSnapshot,
        sanitizeHTML, isValidURL, truncate,
        RateLimiter, SecureSession
    } from './firebase.js';

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentUser         = null;
    let isLoggingOut        = false;
    let assignedShows       = [];
    let selectedShow        = null;
    let originalFormData    = {};
    let unsubscribeSnapshot = null;
    let pendingSaveData     = null;

    const SHOWS_COLLECTION  = 'shows';
    const MAX_REMARKS       = 500;
    const MAX_REMARK_LENGTH = 1000;
    const chatLimiter = new RateLimiter(10, 60 * 1000);
    const saveLimiter = new RateLimiter(5,  60 * 1000);
    const escapeHtml  = sanitizeHTML;

    const WRITER_EDITABLE_FIELDS = {
        'showAssetsLink':        'showAssetsLink',
        'localizationNotesLink': 'localizationNotesLink',
        'screenplayDraft1':      'screenplayDraft1',
        'screenplayDraft2':      'screenplayDraft2',
        'finalScreenplayLink':   'finalScreenplayLink',
        'advanceInvoiceLink':    'advanceInvoiceLink',
        'finalInvoiceLink':      'finalInvoiceLink',
    };
    const WRITER_FIELD_IDS = Object.keys(WRITER_EDITABLE_FIELDS);
    const URL_FIELDS       = ['showAssetsLink','localizationNotesLink','screenplayDraft1','screenplayDraft2','finalScreenplayLink','advanceInvoiceLink','finalInvoiceLink'];
    const LINK_FIELDS_SET  = new Set(URL_FIELDS);
    const FIELD_LABELS     = {
        'showAssetsLink':        'Show Assets Link',
        'localizationNotesLink': 'Localization Notes Link',
        'screenplayDraft1':      'Screenplay Draft 1',
        'screenplayDraft2':      'Screenplay Draft 2',
        'finalScreenplayLink':   'Final Screenplay Link',
        'advanceInvoiceLink':    'Advance Invoice Link',
        'finalInvoiceLink':      'Final Invoice Link',
    };
    const ADMIN_LOCKED_FIELDS = [
        { key:'writerStatus',          label:'Status',                         type:'status',  icon:'üìä' },
        { key:'ogNoOfEpisodes',        label:'OG No. of Episodes',             type:'number',  icon:'üé¨' },
        { key:'finalNoOfEpisodes',     label:'Final No. of Episodes',          type:'number',  icon:'üé¨' },
        { key:'totalApprovedEpisodes', label:'Total Approved No. of Episodes', type:'number',  icon:'‚úÖ' },
        { key:'advancePaymentStatus',  label:'Advance Payment Status',         type:'payment', icon:'üí≥' },
        { key:'finalPaymentStatus',    label:'Final Payment Status',           type:'payment', icon:'üí≥' },
    ];
    const lockedLinkValues = {};

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getShowFieldValue(show, firebaseField) {
        if (show[firebaseField] !== undefined && show[firebaseField] !== null && show[firebaseField] !== '') return show[firebaseField];
        const aliases = { 'ogNoOfEpisodes':'ogEpisodes','finalNoOfEpisodes':'finalEpisodes','totalApprovedEpisodes':'approvedEpisodes' };
        const alias = aliases[firebaseField];
        if (alias && show[alias] !== undefined && show[alias] !== null) return show[alias];
        return '';
    }
    function getDisplayStatus(show)   { return show.writerStatus || show.status || ''; }
    function getDisplayApproved(show) { return show.totalApprovedEpisodes || show.approvedEpisodes || '0'; }
    function getRemarks(show)         { return Array.isArray(show.remarks) ? show.remarks : []; }

    function getStatusClass(s) {
        const map = {
            'Assets Shared':'status-assets-shared',
            'Localization Notes Received':'status-localization-notes-received',
            'Localization Discussion WIP':'status-localization-discussion-wip',
            'Localization Completed':'status-localization-completed',
            'Scripting WIP':'status-scripting-wip',
            'Draft 1 (10-15 Episodes Received)':'status-draft1-partial',
            'Draft 1 (All Episodes Received)':'status-draft1-all',
            'Completed':'status-completed',
            'Paused':'status-paused'
        };
        return map[s] || 'status-default';
    }
    function getPaymentStatusClass(status) {
        if (!status) return 'payment-status-empty';
        if (status === 'Completed') return 'payment-status-completed';
        if (status === 'Pending')   return 'payment-status-pending';
        return 'payment-status-empty';
    }
    function formatTime(iso) {
        const d = new Date(iso), n = new Date();
        const t = d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
        if (d.toDateString() === n.toDateString()) return t;
        const y = new Date(n); y.setDate(y.getDate()-1);
        if (d.toDateString() === y.toDateString()) return `Yesterday ${t}`;
        return `${d.toLocaleDateString([], { month:'short', day:'numeric' })} ${t}`;
    }
    function getDateLabel(iso) {
        const d = new Date(iso), n = new Date();
        if (d.toDateString() === n.toDateString()) return 'Today';
        const y = new Date(n); y.setDate(y.getDate()-1);
        if (d.toDateString() === y.toDateString()) return 'Yesterday';
        return d.toLocaleDateString([], { weekday:'long', month:'short', day:'numeric' });
    }
    function showNotification(type, msg) {
        ['successNotification','errorNotification','infoNotification'].forEach(id => document.getElementById(id).classList.remove('show'));
        if (type === 'success') {
            document.getElementById('successText').textContent = msg;
            document.getElementById('successNotification').classList.add('show');
            setTimeout(() => document.getElementById('successNotification').classList.remove('show'), 5000);
        } else if (type === 'error') {
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorNotification').classList.add('show');
            setTimeout(() => document.getElementById('errorNotification').classList.remove('show'), 10000);
        } else {
            document.getElementById('infoText').textContent = msg;
            document.getElementById('infoNotification').classList.add('show');
            setTimeout(() => document.getElementById('infoNotification').classList.remove('show'), 5000);
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ‚îÄ‚îÄ Locked link fields ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderLockedLinkFields(show) {
        const d1 = show.screenplayDraft1Comments || show.draft1Comments || '';
        lockedLinkValues['draft1Comments'] = d1;
        const d1Text = document.getElementById('draft1CommentsText');
        const d1Copy = document.getElementById('copy-draft1Comments');
        const d1Open = document.getElementById('open-draft1Comments');
        if (d1) {
            d1Text.textContent = d1; d1Text.classList.remove('empty'); d1Text.classList.add('is-link');
            d1Copy.disabled = false; d1Open.disabled = false;
        } else {
            d1Text.textContent = 'Not provided yet'; d1Text.classList.add('empty'); d1Text.classList.remove('is-link');
            d1Copy.disabled = true; d1Open.disabled = true;
        }
        const d2 = show.screenplayDraft2Comments || show.draft2Comments || '';
        lockedLinkValues['draft2Comments'] = d2;
        const d2Text = document.getElementById('draft2CommentsText');
        const d2Copy = document.getElementById('copy-draft2Comments');
        const d2Open = document.getElementById('open-draft2Comments');
        if (d2) {
            d2Text.textContent = d2; d2Text.classList.remove('empty'); d2Text.classList.add('is-link');
            d2Copy.disabled = false; d2Open.disabled = false;
        } else {
            d2Text.textContent = 'Not provided yet'; d2Text.classList.add('empty'); d2Text.classList.remove('is-link');
            d2Copy.disabled = true; d2Open.disabled = true;
        }
    }

    window.copyLockedField = function(key, btnId) {
        const link = lockedLinkValues[key];
        if (!link) return;
        navigator.clipboard.writeText(link).then(() => {
            const btn = document.getElementById(btnId);
            if (btn) {
                const orig = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!'; btn.classList.add('copied');
                setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('copied'); }, 2000);
            }
            showNotification('success', 'Link copied to clipboard!');
        }).catch(() => showNotification('error', 'Failed to copy link.'));
    };

    window.openLockedField = function(key) {
        const link = lockedLinkValues[key];
        if (!link) return;
        try {
            const url = new URL(link);
            if (url.protocol === 'http:' || url.protocol === 'https:') window.open(link, '_blank', 'noopener,noreferrer');
            else showNotification('error', 'Invalid link protocol.');
        } catch(e) { showNotification('error', 'Invalid link format.'); }
    };

    // ‚îÄ‚îÄ Admin-locked fields ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderAdminLockedFields(show) {
        const grid = document.getElementById('adminLockedFieldsGrid');
        grid.innerHTML = '';
        ADMIN_LOCKED_FIELDS.forEach(field => {
            let value = '';
            if (show[field.key] !== undefined && show[field.key] !== null && show[field.key] !== '') value = show[field.key];
            else if (field.type === 'number') {
                const aliases = { 'ogNoOfEpisodes':'ogEpisodes','finalNoOfEpisodes':'finalEpisodes','totalApprovedEpisodes':'approvedEpisodes' };
                const alias = aliases[field.key];
                if (alias && show[alias] !== undefined && show[alias] !== null && show[alias] !== '') value = show[alias];
            }
            const item = document.createElement('div');
            item.className = 'admin-field-item';
            if (field.type === 'status') {
                item.innerHTML = `<div class="admin-field-header"><span class="admin-field-label">${field.icon} ${escapeHtml(field.label)} <span style="font-size:0.6rem;opacity:0.45;">üîí</span></span></div><div class="admin-field-value"><span class="status-badge ${getStatusClass(value)}">${escapeHtml(value || 'Not Set')}</span></div>`;
            } else if (field.type === 'number') {
                const display = (value !== '' && value !== undefined && value !== null) ? String(value) : '‚Äî';
                item.innerHTML = `<div class="admin-field-header"><span class="admin-field-label">${field.icon} ${escapeHtml(field.label)} <span style="font-size:0.6rem;opacity:0.45;">üîí</span></span></div><div class="admin-field-value"><span style="font-size:1.125rem;font-weight:700;color:#2c3e50;">${escapeHtml(display)}</span></div>`;
            } else if (field.type === 'payment') {
                item.innerHTML = `<div class="admin-field-header"><span class="admin-field-label">${field.icon} ${escapeHtml(field.label)} <span style="font-size:0.6rem;opacity:0.45;">üîí</span></span></div><div class="admin-field-value"><span class="payment-status-badge ${getPaymentStatusClass(value)}">${escapeHtml(value || 'Not Set')}</span></div>`;
            }
            grid.appendChild(item);
        });
    }

    // ‚îÄ‚îÄ Confirm Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildConfirmPreviewHtml(newData) {
        if (!selectedShow) return '';
        const showName = escapeHtml(selectedShow.showOgName || selectedShow.showEnglishName || 'Untitled');
        const showCode = escapeHtml(selectedShow.showCode || 'N/A');
        let html = `<div class="confirm-show-info"><span class="confirm-show-code">${showCode}</span><span class="confirm-show-name">${showName}</span></div>`;
        const changes = [], unchanged = [];
        WRITER_FIELD_IDS.forEach(formId => {
            const firebaseField = WRITER_EDITABLE_FIELDS[formId];
            const newVal = String(newData[firebaseField] || '').trim();
            const oldVal = String(originalFormData[formId] || '').trim();
            const label  = FIELD_LABELS[firebaseField] || firebaseField;
            const isLink = LINK_FIELDS_SET.has(formId);
            if (newVal !== oldVal) changes.push({ label, oldVal, newVal, isLink });
            else if (newVal) unchanged.push({ label, value: newVal, isLink });
        });
        if (changes.length > 0) {
            html += `<div class="confirm-summary"><span class="summary-icon">‚úèÔ∏è</span><span><strong>${changes.length} field${changes.length !== 1 ? 's' : ''}</strong> will be updated</span></div>`;
            html += `<div class="confirm-section-title">üîÑ Changes (${changes.length})</div><div class="confirm-changes-list">`;
            changes.forEach(({ label, oldVal, newVal, isLink }) => {
                const oldDisplay = oldVal ? (isLink ? escapeHtml(truncate(oldVal, 60)) : escapeHtml(oldVal)) : '<em style="color:#adb5bd">Empty</em>';
                const newDisplay = newVal ? (isLink ? escapeHtml(truncate(newVal, 60)) : escapeHtml(newVal)) : '<em style="color:#dc3545">Will be cleared</em>';
                html += `<div class="confirm-change-row changed"><div class="confirm-change-field">${escapeHtml(label)}</div><div class="confirm-change-diff"><span class="confirm-old-value">${oldDisplay}</span><span class="confirm-new-value ${isLink ? 'is-link' : ''}">‚Üí ${newDisplay}</span></div></div>`;
            });
            html += '</div>';
        } else {
            html += `<div class="confirm-no-changes"><div class="confirm-no-changes-icon">‚úÖ</div><p>No changes detected.</p></div>`;
        }
        if (unchanged.length > 0 && changes.length > 0) {
            html += `<details style="margin-top:0.5rem;"><summary style="cursor:pointer;font-size:0.8125rem;color:#6c757d;">üìã Unchanged fields (${unchanged.length})</summary><div class="confirm-changes-list">`;
            unchanged.forEach(({ label, value, isLink }) => {
                html += `<div class="confirm-change-row"><div class="confirm-change-field">${escapeHtml(label)}</div><div class="confirm-change-value ${isLink ? 'is-link' : ''}">${isLink ? escapeHtml(truncate(value, 50)) : escapeHtml(value)}</div></div>`;
            });
            html += '</div></details>';
        }
        return html;
    }

    function openConfirmModal(previewHtml, onConfirm) {
        document.getElementById('confirmBody').innerHTML = previewHtml;
        const saveBtn = document.getElementById('confirmSaveBtn');
        const newBtn  = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newBtn, saveBtn);
        newBtn.addEventListener('click', async function() {
            newBtn.disabled = true; newBtn.innerHTML = '‚è≥ Saving...';
            await onConfirm();
            newBtn.disabled = false; newBtn.innerHTML = '‚úì Confirm & Save';
            closeConfirmModal();
        });
        document.getElementById('confirmModal').classList.add('show');
    }

    window.closeConfirmModal = function() {
        document.getElementById('confirmModal').classList.remove('show');
        pendingSaveData = null;
    };
    document.getElementById('confirmModal').addEventListener('click', function(e) { if (e.target === this) closeConfirmModal(); });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('confirmModal').classList.contains('show')) closeConfirmModal();
    });

    // ‚îÄ‚îÄ Render Remarks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderRemarks(remarks) {
        const area    = document.getElementById('remarksMessagesArea');
        const countEl = document.getElementById('remarksMsgCount');
        countEl.textContent = `${remarks.length} message${remarks.length !== 1 ? 's' : ''}`;

        if (!remarks || !remarks.length) {
            area.innerHTML = `<div class="remarks-empty"><div class="remarks-empty-icon">üí¨</div><div class="remarks-empty-text">No remarks yet</div><div class="remarks-empty-sub">Start the conversation below</div></div>`;
            return;
        }

        let html = '<div class="remarks-inner">', lastDate = '', lastSender = '';
        remarks.forEach(msg => {
            const dl = getDateLabel(msg.timestamp);
            if (dl !== lastDate) {
                html += `<div class="remarks-date-sep"><span class="remarks-date-label">${dl}</span></div>`;
                lastDate = dl; lastSender = '';
            }
            const isWriter   = msg.role === 'writer';
            const rowClass   = isWriter ? 'from-writer' : 'from-admin';
            const senderName = msg.senderName || msg.senderEmail || '?';
            const initial    = senderName.charAt(0).toUpperCase();
            const showName   = senderName !== lastSender;
            lastSender = senderName;
            html += `<div class="msg-row ${rowClass}">
                <div class="msg-avatar">${escapeHtml(initial)}</div>
                <div class="msg-group">
                    ${showName ? `<div class="msg-sender-name">${escapeHtml(truncate(senderName, 40))}</div>` : ''}
                    <div class="msg-bubble">${escapeHtml(truncate(msg.text || '', MAX_REMARK_LENGTH))}</div>
                    <div class="msg-time">${formatTime(msg.timestamp)}</div>
                </div>
            </div>`;
        });
        html += '</div>';
        area.innerHTML = html;
        area.scrollTop = area.scrollHeight;
    }

    // ‚îÄ‚îÄ Send writer message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.sendWriterMessage = async function() {
        if (!selectedShow) return;
        if (!chatLimiter.canProceed()) {
            showNotification('error', 'Sending too fast. Please wait.');
            return;
        }

        const input = document.getElementById('writerChatInput');
        const text  = truncate(input.value.trim(), MAX_REMARK_LENGTH);
        if (!text) return;

        const btn = document.getElementById('writerChatSendBtn');
        btn.disabled = true;

        const currentRemarks = getRemarks(selectedShow);
        if (currentRemarks.length >= MAX_REMARKS) {
            showNotification('error', `Maximum ${MAX_REMARKS} remarks reached.`);
            btn.disabled = false;
            return;
        }

        const userData   = SecureSession.getUserData() || {};
        const writerName = truncate(userData.name || currentUser.email.split('@')[0], 50);

        const newMsg = {
            text,
            senderEmail: currentUser.email,
            senderName:  writerName,
            role:        'writer',
            timestamp:   new Date().toISOString()
        };

        try {
            await updateDoc(doc(db, SHOWS_COLLECTION, selectedShow.showCode), {
                remarks:       [...currentRemarks, newMsg],
                updatedAt:     new Date().toISOString(),
                lastUpdatedBy: currentUser.email
            });
            input.value = '';
            input.style.height = 'auto';
            updateCharCounter('');
            showNotification('success', 'Remark sent!');
        } catch(e) {
            if (e.code === 'permission-denied') showNotification('error', 'Permission denied.');
            else showNotification('error', 'Failed to send: ' + e.message);
        }

        btn.disabled = false;
        input.focus();
    };

    function updateCharCounter(val) {
        const el = document.getElementById('remarksCharCounter');
        if (!el) return;
        const len = val.length;
        el.textContent = `${len} / 1000`;
        el.classList.remove('warn', 'limit');
        if (len >= 1000)     el.classList.add('limit');
        else if (len >= 800) el.classList.add('warn');
    }

    const chatInput = document.getElementById('writerChatInput');
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        updateCharCounter(this.value);
    });
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendWriterMessage(); }
    });

    // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    onAuthStateChanged(auth, async (user) => {
        if (isLoggingOut) return;
        if (user && user.emailVerified) {
            if (user.email.endsWith('@dashverse.ai')) {
                window.location.replace('admin-dashboard.html');
                return;
            }
            currentUser = user;
            const ud = SecureSession.getUserData() || {};
            const n  = ud.name || user.email.split('@')[0];
            const fn = n.split(' ')[0];
            document.getElementById('userName').textContent           = fn;
            document.getElementById('welcomeName').textContent        = fn;
            document.getElementById('userAvatar').textContent         = fn.charAt(0).toUpperCase();
            document.getElementById('remarksInputAvatar').textContent = fn.charAt(0).toUpperCase();
            await loadAssignedShows();
            setupRealtimeListener();
        } else {
            window.location.replace('login.html');
        }
    });

    async function loadAssignedShows() {
        try {
            const email = currentUser.email.toLowerCase().trim();
            const snap  = await getDocs(query(collection(db, SHOWS_COLLECTION), where('writerEmail', '==', email)));
            assignedShows = [];
            snap.forEach(d => { const data = d.data(); data._id = d.id; assignedShows.push(data); });
            if (!assignedShows.length) {
                displayNoShows();
                document.getElementById('statsGrid').style.display = 'none';
            } else {
                displayShows();
                updateStats();
                document.getElementById('statsGrid').style.display = 'grid';
            }
        } catch(e) {
            showNotification('error', 'Failed to load shows: ' + e.message);
            displayNoShows();
        }
    }

    function setupRealtimeListener() {
        if (unsubscribeSnapshot) unsubscribeSnapshot();
        const email = currentUser.email.toLowerCase().trim();
        unsubscribeSnapshot = onSnapshot(
            query(collection(db, SHOWS_COLLECTION), where('writerEmail', '==', email)),
            (snap) => {
                assignedShows = [];
                snap.forEach(d => { const data = d.data(); data._id = d.id; assignedShows.push(data); });
                if (document.getElementById('showSelectionCard').style.display !== 'none') {
                    if (!assignedShows.length) {
                        displayNoShows();
                        document.getElementById('statsGrid').style.display = 'none';
                    } else {
                        displayShows();
                        updateStats();
                        document.getElementById('statsGrid').style.display = 'grid';
                    }
                }
                if (selectedShow) {
                    const updated = assignedShows.find(s => s.showCode === selectedShow.showCode);
                    if (updated) {
                        selectedShow = updated;
                        displayLockedShowInfo(updated);
                        renderAdminLockedFields(updated);
                        renderLockedLinkFields(updated);
                        renderRemarks(getRemarks(updated));
                    } else {
                        showNotification('info', 'This show has been updated by admin.');
                        backToSelection();
                    }
                }
            }
        );
    }

    function displayNoShows() {
        document.getElementById('showsContainer').innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìã</div><h3>No Shows Assigned</h3><p>No shows have been assigned to <strong>${escapeHtml(currentUser.email)}</strong> yet.</p></div>`;
    }

    function displayShows() {
        document.getElementById('showsContainer').innerHTML = '<div class="show-cards-grid" id="showCardsGrid"></div>';
        const grid = document.getElementById('showCardsGrid');
        assignedShows.forEach((show, i) => {
            const ds     = getDisplayStatus(show);
            const sc     = getStatusClass(ds);
            const rm     = getRemarks(show);
            const advPay = show.advancePaymentStatus || '';
            const finPay = show.finalPaymentStatus   || '';
            const card   = document.createElement('div');
            card.className = 'show-card';
            card.onclick   = () => selectShow(i);
            card.innerHTML = `<div class="show-card-header"><span class="show-id-badge">${escapeHtml(show.showCode || 'N/A')}</span><span class="status-badge ${sc}">${escapeHtml(ds || 'Not Set')}</span></div>
                <div class="show-name">${escapeHtml(show.showOgName || show.showEnglishName || 'Untitled')}</div>
                <div class="show-details">
                    <div class="detail-row"><span class="detail-label">Language:</span><span>${escapeHtml(show.language || 'N/A')}</span></div>
                    <div class="detail-row"><span class="detail-label">Approved Episodes:</span><span>${getDisplayApproved(show)}</span></div>
                    <div class="detail-row"><span class="detail-label">Advance Pay:</span><span class="payment-status-badge ${getPaymentStatusClass(advPay)}" style="font-size:0.6875rem;padding:0.15rem 0.5rem;">${escapeHtml(advPay || 'Not Set')}</span></div>
                    <div class="detail-row"><span class="detail-label">Final Pay:</span><span class="payment-status-badge ${getPaymentStatusClass(finPay)}" style="font-size:0.6875rem;padding:0.15rem 0.5rem;">${escapeHtml(finPay || 'Not Set')}</span></div>
                    <div class="detail-row"><span class="detail-label">Remarks:</span><span>üí¨ ${rm.length}</span></div>
                </div>`;
            grid.appendChild(card);
        });
    }

    function updateStats() {
        document.getElementById('assignedShowsCount').textContent = assignedShows.length;
        document.getElementById('inProgressCount').textContent    = assignedShows.filter(s => getDisplayStatus(s) === 'Scripting WIP').length;
        document.getElementById('completedCount').textContent     = assignedShows.filter(s => getDisplayStatus(s) === 'Completed').length;
        document.getElementById('totalEpisodesCount').textContent = assignedShows.reduce((sum, s) => sum + (parseInt(s.totalApprovedEpisodes) || parseInt(s.approvedEpisodes) || 0), 0);
    }

    window.selectShow = function(i) {
        selectedShow = assignedShows[i];
        if (!selectedShow) return;
        document.getElementById('showSelectionCard').style.display = 'none';
        document.getElementById('showEditorCard').style.display   = 'block';
        document.getElementById('statsGrid').style.display        = 'none';
        document.getElementById('editorShowTitle').textContent    = `Show ‚Äî ${selectedShow.showOgName || selectedShow.showEnglishName || 'Untitled'}`;
        displayLockedShowInfo(selectedShow);
        renderAdminLockedFields(selectedShow);
        renderLockedLinkFields(selectedShow);
        WRITER_FIELD_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = getShowFieldValue(selectedShow, WRITER_EDITABLE_FIELDS[id]);
        });
        originalFormData = {};
        WRITER_FIELD_IDS.forEach(id => {
            const el = document.getElementById(id);
            originalFormData[id] = el ? el.value : '';
        });
        renderRemarks(getRemarks(selectedShow));
        document.querySelectorAll('.show-card').forEach((c, j) => c.classList.toggle('selected', j === i));
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function displayLockedShowInfo(show) {
        document.getElementById('lockedFieldsGrid').innerHTML = `
            <div class="field-item"><span class="field-label">Show Code:</span><span class="field-value"><span class="show-id-badge">${escapeHtml(show.showCode || 'N/A')}</span></span></div>
            <div class="field-item"><span class="field-label">Chinese Name:</span><span class="field-value">${escapeHtml(show.showOgName || 'N/A')}</span></div>
            <div class="field-item"><span class="field-label">Working Name:</span><span class="field-value">${escapeHtml(show.showEnglishName || 'N/A')}</span></div>
            <div class="field-item"><span class="field-label">Language:</span><span class="field-value">${escapeHtml(show.language || 'N/A')}</span></div>`;
    }

    window.backToSelection = function() {
        document.getElementById('showSelectionCard').style.display = 'block';
        document.getElementById('showEditorCard').style.display   = 'none';
        document.getElementById('statsGrid').style.display        = 'grid';
        selectedShow = null;
        if (assignedShows.length) { displayShows(); updateStats(); }
    };

    window.resetForm = function() {
        if (!confirm('Reset all changes to last saved values?')) return;
        WRITER_FIELD_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = originalFormData[id] || '';
        });
        showNotification('info', 'Form has been reset.');
    };

    // ‚îÄ‚îÄ Form submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('updateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedShow) { showNotification('error', 'No show selected.'); return; }
        if (!saveLimiter.canProceed()) { showNotification('error', 'Saving too fast. Please wait.'); return; }
        for (const fieldId of URL_FIELDS) {
            const v = document.getElementById(fieldId)?.value?.trim();
            if (v && !isValidURL(v)) {
                showNotification('error', `Invalid URL in "${FIELD_LABELS[WRITER_EDITABLE_FIELDS[fieldId]] || fieldId}".`);
                return;
            }
        }
        const updateData = {};
        WRITER_FIELD_IDS.forEach(id => {
            updateData[WRITER_EDITABLE_FIELDS[id]] = truncate(document.getElementById(id)?.value?.trim() || '', 2000);
        });
        updateData.updatedAt     = new Date().toISOString();
        updateData.lastUpdatedBy = currentUser.email;
        pendingSaveData = updateData;
        openConfirmModal(buildConfirmPreviewHtml(updateData), async () => { await executeSave(); });
    });

    async function executeSave() {
        if (!pendingSaveData || !selectedShow) return;
        const btn = document.getElementById('saveButton');
        btn.disabled = true; btn.textContent = 'Saving...';
        try {
            await updateDoc(doc(db, SHOWS_COLLECTION, selectedShow.showCode), pendingSaveData);
            Object.assign(selectedShow, pendingSaveData);
            WRITER_FIELD_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (el) originalFormData[id] = el.value;
            });
            showNotification('success', '‚úÖ Changes saved successfully!');
        } catch(e) {
            if (e.code === 'permission-denied') showNotification('error', 'Permission denied. Please contact admin.');
            else showNotification('error', 'Failed to save changes: ' + e.message);
        }
        btn.disabled = false; btn.textContent = 'Review & Save Changes';
        pendingSaveData = null;
    }

    // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.logout = function() {
        if (!confirm('Are you sure you want to logout?')) return;
        isLoggingOut = true;
        if (unsubscribeSnapshot) try { unsubscribeSnapshot(); } catch(e) {}
        SecureSession.clear();
        sessionStorage.clear();
        try {
            const bc = new BroadcastChannel('dashverse_auth');
            bc.postMessage({ type: 'logout' }); bc.close();
        } catch(e) {}
        auth.signOut().then(() => window.location.replace('login.html'));
    };

    try {
        const bc = new BroadcastChannel('dashverse_auth');
        bc.onmessage = (e) => {
            if (e.data?.type === 'logout' && !isLoggingOut) {
                isLoggingOut = true;
                if (unsubscribeSnapshot) try { unsubscribeSnapshot(); } catch(e) {}
                SecureSession.clear();
                window.location.replace('login.html');
            }
        };
    } catch(e) {}

    console.log('üöÄ Writer Dashboard loaded');
    </script>
</body>
</html>