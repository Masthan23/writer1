<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email - Dashverse</title>
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .verify-container { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 600px; width: 100%; padding: 60px 50px; text-align: center; }
        .icon { width: 80px; height: 80px; margin: 0 auto 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        h1 { font-size: 2rem; color: #2c3e50; margin-bottom: 20px; }
        .message { font-size: 1.1rem; color: #6c757d; line-height: 1.6; margin-bottom: 30px; }
        .email-highlight { color: #667eea; font-weight: 600; }
        .info-box { background: #e7f3ff; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: left; }
        .info-box strong { color: #2c3e50; display: block; margin-bottom: 10px; }
        .info-box ul { margin-left: 20px; color: #495057; }
        .info-box li { margin-bottom: 8px; }
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; margin-bottom: 15px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { box-shadow: 0 8px 20px rgba(108,117,125,0.4); }
        .links { margin-top: 20px; }
        .links a { color: #667eea; text-decoration: none; font-weight: 500; }
        .links a:hover { color: #764ba2; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @media (max-width: 768px) { .verify-container { padding: 40px 30px; } h1 { font-size: 1.5rem; } }
    </style>
</head>
<body>
    <div class="verify-container">
        <div class="icon">ðŸ“§</div>
        <h1>Verify Your Email</h1>
        <p class="message">
            We've sent a verification link to<br>
            <span class="email-highlight" id="userEmail">your email</span>
        </p>
        <div class="info-box">
            <strong>Next Steps:</strong>
            <ul>
                <li>Check your email inbox (and spam folder)</li>
                <li>Click the verification link in the email</li>
                <li>Return here and click "I've Verified My Email"</li>
            </ul>
        </div>
        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>
        <button class="btn-primary" id="checkBtn">I've Verified My Email</button>
        <button class="btn-primary btn-secondary" id="resendBtn">Resend Verification Email</button>
        <div class="links"><a href="login.html">Back to Sign In</a></div>
    </div>

    <script type="module">
    import { auth, ensureInitialized, sendEmailVerification, onAuthStateChanged, SecureSession, RateLimiter } from './firebase.js';

    const resendLimiter = new RateLimiter(2, 5 * 60 * 1000);
    const pendingData   = SecureSession.getPendingVerification();

    if (!pendingData || !pendingData.email) {
        window.location.href = 'signup.html';
    } else {
        document.getElementById('userEmail').textContent = pendingData.email;
    }

    function showAlert(type, message) {
        const s = document.getElementById('successAlert');
        const e = document.getElementById('errorAlert');
        s.classList.remove('show');
        e.classList.remove('show');
        if (type === 'success') { s.textContent = message; s.classList.add('show'); }
        else { e.textContent = message; e.classList.add('show'); }
        setTimeout(() => { s.classList.remove('show'); e.classList.remove('show'); }, 6000);
    }

    let firebaseReady    = false;
    let currentAuthUser  = null;

    async function waitForFirebase() {
        const checkBtn  = document.getElementById('checkBtn');
        const resendBtn = document.getElementById('resendBtn');
        checkBtn.disabled = true;
        resendBtn.disabled = true;
        try {
            await ensureInitialized();
            firebaseReady = true;
            onAuthStateChanged(auth, (user) => {
                currentAuthUser = user;
                checkBtn.disabled  = false;
                resendBtn.disabled = !user;
            });
        } catch (e) {
            console.error('Firebase init failed:', e);
            showAlert('error', 'Failed to connect to server. Please refresh the page.');
        }
    }

    waitForFirebase();

    document.getElementById('checkBtn').addEventListener('click', async () => {
        const btn = document.getElementById('checkBtn');
        btn.disabled    = true;
        btn.textContent = 'Checking...';
        try {
            if (!firebaseReady) await ensureInitialized();
            if (!currentAuthUser) {
                showAlert('error', 'Session expired. Please sign in or sign up again.');
                btn.disabled    = false;
                btn.textContent = "I've Verified My Email";
                return;
            }
            await currentAuthUser.reload();
            if (currentAuthUser.emailVerified) {
                showAlert('success', 'Email verified! Redirecting to login...');
                SecureSession.clear();
                setTimeout(() => window.location.href = 'login.html', 2000);
            } else {
                showAlert('error', 'Email not verified yet. Please check your inbox.');
                btn.disabled    = false;
                btn.textContent = "I've Verified My Email";
            }
        } catch (error) {
            console.error('Verification check error:', error);
            showAlert('error', 'Error checking verification. Please try again.');
            btn.disabled    = false;
            btn.textContent = "I've Verified My Email";
        }
    });

    document.getElementById('resendBtn').addEventListener('click', async () => {
        const btn = document.getElementById('resendBtn');
        if (!resendLimiter.canProceed()) {
            showAlert('error', 'Too many attempts. Please wait a few minutes.');
            return;
        }
        btn.disabled    = true;
        btn.textContent = 'Sending...';
        try {
            if (!currentAuthUser) {
                showAlert('error', 'Session expired. Please sign up again.');
                btn.disabled    = false;
                btn.textContent = 'Resend Verification Email';
                return;
            }
            await sendEmailVerification(currentAuthUser);
            showAlert('success', 'Verification email resent! Check your inbox.');
            setTimeout(() => { btn.disabled = false; btn.textContent = 'Resend Verification Email'; }, 30000);
        } catch (error) {
            let msg = 'Error resending email. Please try again later.';
            if (error.code === 'auth/too-many-requests') msg = 'Too many requests. Please wait.';
            showAlert('error', msg);
            btn.disabled    = false;
            btn.textContent = 'Resend Verification Email';
        }
    });
    </script>
</body>
</html>